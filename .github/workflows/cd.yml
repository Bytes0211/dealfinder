name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: dealfinder

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Output image URI
        run: |
          echo "IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_OUTPUT

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.14"
      
      - name: Terraform Init
        working-directory: infrastructure/environments/dev
        run: terraform init
      
      - name: Terraform Plan
        working-directory: infrastructure/environments/dev
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: infrastructure/environments/dev
        run: terraform apply -auto-approve tfplan
      
      - name: Upload Terraform state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infrastructure/environments/dev/.terraform/

  deploy-lambda-functions:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip install --system -e .
      
      - name: Package Lambda functions
        run: |
          mkdir -p lambda-packages
          # TODO: Package individual Lambda functions when implemented
          # zip -r lambda-packages/scanner-agent.zip src/dealfinder/agents/scanner/
          # zip -r lambda-packages/ensemble-agent.zip src/dealfinder/agents/ensemble/
          echo "Lambda packaging will be implemented when agents are ready"
      
      - name: Deploy Lambda functions
        run: |
          # TODO: Deploy Lambda functions using AWS CLI
          # aws lambda update-function-code --function-name scanner-agent --zip-file fileb://lambda-packages/scanner-agent.zip
          echo "Lambda deployment will be implemented when agents are ready"

  post-deployment-tests:
    runs-on: ubuntu-latest
    needs: deploy-lambda-functions
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Run smoke tests
        run: |
          # TODO: Implement smoke tests
          echo "Running smoke tests against deployed infrastructure..."
          # Test VPC connectivity
          aws ec2 describe-vpcs --filters "Name=tag:Project,Values=dealfinder" --region $AWS_REGION
          # Test S3 buckets
          aws s3 ls | grep dealfinder-dev
          # Test DynamoDB tables
          aws dynamodb list-tables --region $AWS_REGION | grep dealfinder-dev
          echo "âœ“ Smoke tests passed"
